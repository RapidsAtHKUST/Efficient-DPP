#!/bin/bash

# getopt preprocessing
TEMP=`getopt -o hn: --long help,rec:,arr:,loc: -- "$@"`

# set will reorder the sequence of the parameters
eval set -- "$TEMP"

CUDA_COMPARE_HOME="$(cd "`dirname "$0"`"/..; pwd)"

# parameters
IS_INPUT=false						# whether to input the data file
DATASIZE=16000000					# default data size if 16,000,000

# data directory
INPUT_REC_DIR=
INPUT_ARR_DIR=
INPUT_LOC_DIR=

CURRENT_DIR="$(pwd)"

# process the parameters
while true ; do
	case "$1" in
		-h|--help)
			echo "Options:";
			echo " -h, --help					show usage guide";
			echo " -n						set the data size(default=16,000,000)";
			echo " --rec=/your/record/data_dir		read record data from data dir(then it will use the fixed data)";
			echo " --arr=/your/array/data_dir		read array data from data dir(then it will use the fixed data)";
			echo " --loc=/your/array/data_dir		read location data from data dir(then it will use the fixed data)";
			shift
		;;	
		
		-n)
			 DATASIZE=$2
			 res=`echo $2 | bc`
			 if [[ -z "$res" || "$res" -ne "$2" ]]		#string comparison needs double []
			 then
				 echo "Data size invalid."
				 exit 1
			 fi
			 shift 2
		;;	

		--rec)
			IS_INPUT=true
			INPUT_REC_DIR="$CURRENT_DIR/$2" 
			shift 2
		;;

		--arr)
			IS_INPUT=true
			INPUT_ARR_DIR="$CURRENT_DIR/$2"
			shift 2
		;;

		--loc)
			IS_INPUT=true
			INPUT_LOC_DIR="$CURRENT_DIR/$2"
			shift 2
		;;
		
		# the end of the parameter list
		--) shift ; break ;;
		*) echo $1; exit 1
	esac	
done

#output the parameters for checking
echo ""
echo "Starting to launch cuda_compare..."

if [ $IS_INPUT == true ]
then
	if [ -z "$INPUT_REC_DIR" ]
	then
		echo "Record directory is empty"
		exit 1
	fi

	if [ -z "$INPUT_ARR_DIR" ]
	then
		echo "Array directory is empty"
		exit 1
	fi
	
	if [ -z "$INPUT_LOC_DIR" ]
	then
		echo "Location directory is empty"
		exit 1
	fi

	echo "Input record data directory : $INPUT_REC_DIR"
	echo "Input array data directory : $INPUT_ARR_DIR"	
	echo "Input location data directory : $INPUT_LOC_DIR"	
	eval "nvprof $CUDA_COMPARE_HOME/bin/executor $INPUT_REC_DIR $INPUT_ARR_DIR $INPUT_LOC_DIR"
else
	echo "Fast run..."
	echo "Data size: $DATASIZE"
	eval "nvprof $CUDA_COMPARE_HOME/bin/executor $DATASIZE"
fi

